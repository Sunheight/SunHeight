"use strict";(self["webpackChunkdev"]=self["webpackChunkdev"]||[]).push([[2972],{2972:function(t,e,a){a.r(e),a.d(e,{default:function(){return p}});var s=function(){var t=this,e=t._self._c;return e("div",[e("modal",{staticClass:"userManagementDept",attrs:{nomask:"",persistent:"",noselect:""},on:{close:function(e){return t.$emit("close")}},model:{value:t.stat.dept.valid,callback:function(e){t.$set(t.stat.dept,"valid",e)},expression:"stat.dept.valid"}},[e("div",{staticClass:"subDeptCard",attrs:{catskill:"",lighten:"",bg:""}},[e("header",{staticClass:"bar",attrs:{flex:"",jsb:"",ac:""}},[e("div",{attrs:{"ls-xl":""}},[t._v(t._s(t.titles[t.stat.dept.titleIndex]))]),e("ico",{attrs:{xs:"",pointer:"",bold:""},on:{click:t.closeModal}},[t._v("ui-close")])],1),e("main",[e("table",{attrs:{sm:""}},[e("tbody",[e("tr",[e("td",{staticClass:"field"},[t._v("部门名称")]),e("td",{staticClass:"value"},[e("field",{attrs:{fill:"",noborder:"","pl-xl":"",ac:""},model:{value:t.data.dept.name,callback:function(e){t.$set(t.data.dept,"name",e)},expression:"data.dept.name"}},[t._v("必填")])],1)]),e("tr",[e("td",{staticClass:"field"},[t._v("部门负责人")]),e("td",{staticClass:"value",attrs:{relative:"","z-index-5":""}},[e("field",{staticStyle:{transform:"translateY(0)"},attrs:{select:"",fill:"",tile:"","pl-xl":"",ac:"",placeholder:"必填"},model:{value:t.data.dept.manager_fullName,callback:function(e){t.$set(t.data.dept,"manager_fullName",e)},expression:"data.dept.manager_fullName"}},[e("div",{staticClass:"scrollBox"},t._l(t.managerList,(function(a){return e("div",{staticClass:"selectSlot",on:{click:function(e){return t.selectManager(a)}}},[e("div",{staticClass:"item"},[t._v(t._s("["+t.roles[a.roleIndex]+"] "+a.fullName))])])})),0)])],1)]),e("tr",[e("td",{staticClass:"field"},[t._v("部门电话")]),e("td",{staticClass:"value"},[e("field",{attrs:{fill:"",noborder:"","pl-xl":"",ac:""},model:{value:t.data.dept.officePhone,callback:function(e){t.$set(t.data.dept,"officePhone",e)},expression:"data.dept.officePhone"}},[t._v("选填")])],1)]),e("tr",[e("td",{staticClass:"field"},[t._v("上级部门")]),e("td",{staticClass:"value",attrs:{relative:"","z-index-4":""}},[e("field",{staticStyle:{transform:"translateY(0)"},attrs:{select:"",fill:"",tile:"","pl-xl":"",ac:"",invalid:t.data.dept.superiorDeptItem&&0===t.data.dept.superiorDeptItem.id,placeholder:"必填"},model:{value:t.data.dept.superiorDeptName,callback:function(e){t.$set(t.data.dept,"superiorDeptName",e)},expression:"data.dept.superiorDeptName"}},t._l(t.data.tree.companys,(function(a,s){return e("div",{key:"company-"+s,staticClass:"selectSlot"},[e("div",{staticClass:"company item",class:{invalid:a.unselectable},on:{click:function(e){return t.selectSuperiorDept(a)}}},[t._v(" "+t._s(a.name)+" ")]),t._l(a.children,(function(a,s){return e("div",{key:"dept-"+s},[e("div",{staticClass:"dept item",class:{invalid:a.unselectable},on:{click:function(e){return t.selectSuperiorDept(a)}}},[t._v(" "+t._s(a.name)+" ")]),t._l(a.children,(function(a,s){return e("div",{key:"subDeptIndex-"+s},[e("div",{staticClass:"subDept item",class:{invalid:a.unselectable},on:{click:function(e){return t.selectSuperiorDept(a)}}},[t._v(" "+t._s(a.name)+" ")])])}))],2)}))],2)})),0)],1)])])]),e("div",{staticClass:"btnBox",attrs:{flex:"",jsb:"",ac:"","mt-xl":"","xl-mt":""}},[e("div",[t.deletable&&t.data.dept.id?e("btn",{attrs:{outlined:"",red:"",sm:"",title:"请慎重操作",pending:t.stat.dept.pending},on:{click:t.showDelete}},[t._v(" 删除 ")]):t._e()],1),e("div",{attrs:{flex:""}},[e("btn",{attrs:{flat:"",sm:"",grey:"",bg:"","mr-xl":""},on:{click:t.closeModal}},[t._v("取消")]),e("btn",{attrs:{flat:"",sm:"",grey:"",bg:"","mr-xl":"",invalid:""}},[t._v("暂存")]),e("btn",{attrs:{flat:"",sm:"",blue:"",bg:"","mr-md":"",pending:t.stat.dept.pending},on:{click:t.submitDept}},[t._v("提交")])],1)])])])]),e("modal",{attrs:{relative:"","z-index-1":"",persistent:"",noselect:""},model:{value:t.stat.dept.deleteConfirm,callback:function(e){t.$set(t.stat.dept,"deleteConfirm",e)},expression:"stat.dept.deleteConfirm"}},[e("p",{attrs:{lg:"",catskill:"",lighten:"",bold:"","ls-sm":""}},[t._v(" "+t._s("确认要删除【"+t.data.dept.name+"】吗？ 删除部门不影响其成员数据")+" ")]),e("div",{attrs:{flex:"",je:"",ac:"","mt-xl":"","md-mt":"","py-xl":""}},[e("btn",{attrs:{sm:"","py-sm":"","px-xl":"",outlined:"",red:"",lighten:"","mr-xl":"","md-mr":"",pending:t.stat.dept.pending},on:{click:t.deleteDept}},[t._v(" 删除 ")]),e("btn",{attrs:{sm:"","py-sm":"","px-xl":"",outlined:"",green:""},on:{click:function(e){t.stat.dept.deleteConfirm=!1}}},[t._v("返回")])],1)])],1)},i=[],l=(a(4114),{name:"userManagementDept",inject:["data","stat","snap","api"],props:["getTrees"],data(){return{titles:["添加子部门","修改部门信息"],roles:["员工","主管","经理","高管"],managerList:[],followers:[]}},computed:{deletable(){return this.$store.state.devOption.department.deletable}},watch:{"stat.dept.valid":{handler:function(t){if(t){let t=this.stat.tree.current;switch(this.stat.dept.action){case"insert":if(this.initManagerList(),t){let e=t.level.split(".");if(e.length>4){let e=this.getSuperiorDeptBy(t.level);this.data.dept.superiorDeptItem=e,this.data.dept.superiorDeptName=e.name}else this.data.dept.superiorDeptItem=t,this.data.dept.superiorDeptName=t.name}break;case"update":this.initManagerList().then((e=>{for(let a=0;a<e.length;a++)if(e[a].id===parseInt(t.manager_id)){this.data.dept.manager_fullName=e[a].fullName,this.data.dept.managerItem=e[a];break}}));for(let a in t)this.data.dept[a]=t[a];let e=this.getSuperiorDeptBy(t.level);this.data.dept.superiorDeptItem=e,this.data.dept.superiorDeptName=e.name,this.data.dept.rawLevel=e.level+e.id+".",this.checkUnselectable();break}}else this.resetDept(),this.clearUnselectable()}}},methods:{checkUnselectable(){let t=Object.keys(this.data.tree),e=t[this.stat.tree.current.level.split(".").length-2];for(let a=0;a<t.length;a++)t[a]!==e&&this.data.tree[t[a]].forEach((t=>{t.unselectable=!0}))},clearUnselectable(){let t=Object.keys(this.data.tree);for(let e=0;e<t.length;e++)this.data.tree[t[e]].forEach((t=>{t.unselectable=!1}))},initManagerList(){return new Promise((t=>{this.$http.get(this.api.managers).then((e=>{this.managerList=e.data,t(e.data)}))}))},getSuperiorDeptBy(t){let e=t.split("."),a=Number(e[e.length-2]);for(let s=0;s<this.data.raws.length;s++)if(this.data.raws[s].id===a)return this.data.raws[s]},submitDept(){if(!this.data.dept.name||!this.data.dept.superiorDeptName||!this.data.dept.manager_fullName)return void this.$hint({innerHTML:"请输入完整的部门信息",color:"red"});this.stat.dept.pending=!0;let t={manager_id:parseInt(this.data.dept.manager_id),manager_fullName:this.data.dept.manager_fullName,name:this.data.dept.name,officePhone:this.data.dept.officePhone,level:this.data.dept.superiorDeptItem.level+this.data.dept.superiorDeptItem.id+".",seq:1,mtime:"",ctime:"",muser_id:1,cuser_id:1},e="update"===this.stat.dept.action?"put":"post",a="update"===this.stat.dept.action?"/"+this.stat.tree.current.id:"";if("update"===this.stat.dept.action&&t.level!==this.data.dept.rawLevel&&this.followers.length>0){for(let t of this.followers)t.level=this.data.dept.superiorDeptItem.level+this.data.dept.superiorDeptItem.id+"."+t.suffix;t.followers=this.followers,a+="?changeLevel=true"}this.$http[e](this.api.dept+a,t).then((t=>{1!==t.data&&this.$hint({innerHTML:"提交失败，请重试",color:"red"}),this.getTrees().then((()=>{this.resetDept()}))}))},showDelete(){0===this.stat.tree.current.children.length?this.stat.dept.deleteConfirm=!0:this.$hint({innerHTML:"请先删除子部门",color:"red"})},deleteDept(){this.stat.dept.pending=!0,this.$http.delete(this.api.dept+"/"+this.data.dept.id).then((t=>{1!==t.data&&this.$hint({innerHTML:"删除失败，请重试",color:"red"}),this.$emit("deleted"),this.getTrees().then((()=>{this.resetDept()}))}))},resetDept(){for(let t in this.data.dept)this.data.dept[t]=this.snap.dept[t];for(let t in this.stat.dept)this.stat.dept[t]=this.snap.stat.dept[t]},selectManager(t){this.data.dept.manager_fullName=t.fullName,this.data.dept.managerItem=t},selectSuperiorDept(t){if("update"===this.stat.dept.action){if(t.unselectable)return void this.$message.error("部门只可同级移动，请点击可用部门");let e=[],a=this.stat.tree.current.level;if(this.stat.tree.current.children.length)for(let t of this.stat.tree.current.children)if(t.suffix=t.level.split(a)[1],e.push(t),t.children.length)for(let s of t.children)s.suffix=s.level.split(a)[1],e.push(s);this.followers=e;for(let s=0;s<this.data.raws.length;s++)if(this.data.raws[s].id===t.id){t=this.data.raws[s];break}}this.data.dept.superiorDeptName=t.name,this.data.dept.superiorDeptItem=t},closeModal(){this.stat.dept.pending||(this.stat.dept.valid=!1)}}}),r=l,d=a(1656),n=(0,d.A)(r,s,i,!1,null,"5086c337",null),p=n.exports}}]);